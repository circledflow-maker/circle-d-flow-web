<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Event | Circle D Flow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;300;400;500;600;700;800&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        /* Custom styles to match the theme */
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #0F0A13;
            color: white;
        }

        .font-serif {
            font-family: 'Playfair Display', serif;
        }

        .text-electric {
            color: #9A4DFF;
        }

        .text-amber {
            color: #FFAE42;
        }

        .bg-electric {
            background-color: #9A4DFF;
        }

        .border-electric {
            border-color: #9A4DFF;
        }
    </style>
</head>

<body
    class="bg-[#0F0A13] text-white min-h-screen relative overflow-x-hidden selection:bg-electric selection:text-white">

    <!-- Custom Cursor -->
    <div id="cursor"
        class="fixed w-12 h-12 pointer-events-none z-[200] transition-transform duration-100 hidden md:block">
        <img src="Assets/images/logo.png" class="w-full h-full object-contain drop-shadow-lg" alt="Cursor">
    </div>

    <!-- Navbar -->
    <nav class="fixed w-full z-50 transition-all duration-300 border-b border-white/5 bg-[#0F0A13]/80 backdrop-blur-md"
        id="navbar">
        <div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-3 group">
                <div
                    class="relative w-10 h-10 overflow-hidden rounded-full border border-white/20 group-hover:border-electric transition-colors">
                    <img src="Assets/images/logo.png" alt="CDF Logo" class="w-full h-full object-cover">
                </div>
                <span
                    class="font-serif font-bold text-xl tracking-wide group-hover:text-electric transition-colors">Circle
                    D Flow</span>
            </a>
            <div class="flex items-center gap-6">
                <a href="dashboard.html" class="text-white/60 hover:text-white transition-colors">Dashboard</a>
            </div>
        </div>
    </nav>

    <main class="pt-32 pb-20 px-6 max-w-3xl mx-auto">

        <div id="access-denied" class="hidden text-center py-20">
            <span class="material-symbols-outlined text-6xl text-red-500 mb-4">lock</span>
            <h1 class="text-3xl font-bold mb-4">Access Restricted</h1>
            <p class="text-mist mb-8">You must be Level 5 (Flow Master) or higher to create public events.</p>
            <a href="dashboard.html" class="px-6 py-3 bg-white/10 hover:bg-white/20 rounded-lg transition-colors">Return
                to Dashboard</a>
        </div>

        <div id="event-form-container">
            <div class="mb-10">
                <h1 class="text-4xl font-serif font-bold mb-2">Create New Event</h1>
                <p class="text-mist">Host your own experience on the Circle D Flow network.</p>
            </div>

            <form id="create-event-form" class="space-y-8">

                <!-- Basic Info -->
                <div class="space-y-4">
                    <label class="block">
                        <span class="text-sm font-bold uppercase tracking-widest text-electric mb-2 block">Event
                            Title</span>
                        <input type="text" name="title" required
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:border-electric focus:ring-1 focus:ring-electric outline-none transition-all placeholder:text-white/20"
                            placeholder="e.g. Midnight Jazz Session">
                    </label>

                    <div class="grid md:grid-cols-2 gap-6">
                        <label class="block">
                            <span class="text-sm font-bold uppercase tracking-widest text-electric mb-2 block">Date &
                                Time</span>
                            <input type="datetime-local" name="date" required
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:border-electric focus:ring-1 focus:ring-electric outline-none transition-all [color-scheme:dark]">
                        </label>
                        <!-- Replaced Manual Location with Partner Selection below -->
                    </div>

                    <!-- Partner Location Selector -->
                    <div class="space-y-4">
                        <span class="text-sm font-bold uppercase tracking-widest text-electric block">Choose Location
                            (Partner)</span>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="partner-grid">
                            <!-- Populated by JS -->
                        </div>
                        <input type="hidden" name="location" id="location-input" required>
                        <input type="hidden" name="partnerId" id="partner-id-input">
                    </div>

                    <!-- The Booklist (Resources) -->
                    <div class="space-y-4 pt-4 border-t border-white/10">
                        <span class="text-sm font-bold uppercase tracking-widest text-amber block">The Booklist
                            (Resources)</span>
                        <p class="text-xs text-mist mb-2">Request additional services for your event.</p>

                        <div class="space-y-3">
                            <label
                                class="flex items-center gap-3 p-3 bg-white/5 rounded-lg cursor-pointer border border-transparent hover:border-electric/50 transition-all">
                                <input type="checkbox" name="resource_music"
                                    class="w-5 h-5 rounded border-white/20 bg-black/50 text-electric focus:ring-electric">
                                <div>
                                    <span class="font-bold text-white block">Music / DJ Setup</span>
                                    <span class="text-xs text-mist">Sound system & monitoring</span>
                                </div>
                            </label>

                            <label
                                class="flex items-center gap-3 p-3 bg-white/5 rounded-lg cursor-pointer border border-transparent hover:border-electric/50 transition-all">
                                <input type="checkbox" name="resource_visuals"
                                    class="w-5 h-5 rounded border-white/20 bg-black/50 text-electric focus:ring-electric">
                                <div>
                                    <span class="font-bold text-white block">Visuals / Projection</span>
                                    <span class="text-xs text-mist">Projectors & screens</span>
                                </div>
                            </label>

                            <label
                                class="flex items-center gap-3 p-3 bg-white/5 rounded-lg cursor-pointer border border-transparent hover:border-electric/50 transition-all">
                                <input type="checkbox" name="resource_food"
                                    class="w-5 h-5 rounded border-white/20 bg-black/50 text-electric focus:ring-electric">
                                <div>
                                    <span class="font-bold text-white block">Food & Drinks</span>
                                    <span class="text-xs text-mist">Catering or Bar service</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Map Selection & Geocoding -->
                    <div class="space-y-2">
                        <span class="text-sm font-bold uppercase tracking-widest text-electric block">Pin
                            Location</span>

                        <!-- Address Search -->
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="address-search"
                                class="flex-1 bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white text-sm focus:border-electric outline-none"
                                placeholder="Search address (e.g. Rua Nova do Carvalho, Lisbon)">
                            <button type="button" onclick="searchAddress()"
                                class="px-4 py-2 bg-white/10 hover:bg-electric rounded-lg text-white font-bold text-xs uppercase tracking-wider transition-colors">
                                Find
                            </button>
                        </div>

                        <div id="map-picker" class="w-full h-64 rounded-xl border border-white/10 z-0 relative"></div>
                        <input type="hidden" name="coords_lat" id="coords_lat">
                        <input type="hidden" name="coords_lng" id="coords_lng">
                        <p class="text-xs text-mist">Click on the map or search to set the precise location.</p>
                    </div>
                </div>

                <!-- Details -->
                <div class="space-y-4">
                    <label class="block">
                        <span
                            class="text-sm font-bold uppercase tracking-widest text-electric mb-2 block">Description</span>
                        <textarea name="description" rows="4" required
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:border-electric focus:ring-1 focus:ring-electric outline-none transition-all placeholder:text-white/20"
                            placeholder="What can people expect?"></textarea>
                    </label>
                    <label class="block">
                        <span class="text-sm font-bold uppercase tracking-widest text-electric mb-2 block">Cover Image
                            URL</span>
                        <input type="url" name="image" required
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:border-electric focus:ring-1 focus:ring-electric outline-none transition-all placeholder:text-white/20"
                            placeholder="https://...">
                    </label>
                </div>

                <!-- Ticket Link (Link-Only Mode) -->
                <div class="p-6 bg-white/5 border border-white/10 rounded-xl space-y-4">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <span class="material-symbols-outlined text-amber">confirmation_number</span>
                        Ticket Information
                    </h3>

                    <label class="block">
                        <span class="text-sm font-bold uppercase tracking-widest text-electric mb-2 block">Event Link
                            (Required)</span>
                        <input type="url" name="externalUrl" required
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:border-electric focus:ring-1 focus:ring-electric outline-none transition-all placeholder:text-white/20"
                            placeholder="https://shotgun.live/events/..., https://ra.co/events/...">
                        <p class="text-xs text-mist mt-2">All tickets are handled externally. Users will be redirected
                            to this link.</p>
                    </label>

                    <input type="hidden" name="ticketType" value="external">
                    <input type="hidden" name="price" value="0">
                    <input type="hidden" name="quantity" value="0">
                    <input type="hidden" name="isFree" value="false">

                    <!-- Reward Preview -->
                    <div class="mt-4 p-3 bg-white/5 rounded-lg border border-white/5 flex items-center justify-between">
                        <span class="text-xs text-mist font-bold uppercase tracking-wider">Estimated Creator
                            Reward:</span>
                        <span class="text-electric font-bold">300 XP (Standard)</span>
                    </div>
                </div>

                <!-- Reward Preview -->
                <div class="mt-4 p-3 bg-white/5 rounded-lg border border-white/5 flex items-center justify-between">
                    <span class="text-xs text-mist font-bold uppercase tracking-wider">Estimated Creator
                        Reward:</span>
                    <span id="xp-preview" class="text-electric font-bold">1500 XP</span>
                </div>
        </div>

        <div class="pt-6">
            <button type="submit"
                class="w-full py-4 bg-electric hover:bg-electric/90 text-white font-bold uppercase tracking-widest rounded-lg transition-all transform hover:scale-[1.01] shadow-lg shadow-electric/25">
                Publish Event
            </button>
            <p class="text-center text-xs text-mist mt-4">By publishing, you agree to the community guidelines.
            </p>
        </div>

        </form>
        </div>
    </main>

    <script src="gamification.js"></script>
    <script src="notifications.js"></script>
    <script src="events-manager.js"></script>
    <script src="script.js"></script>
    <script>
        // Map Logic
        let map, marker;
        function initMap() {
            // Default Lisbon
            const defaultCoords = [38.716, -9.135];

            map = L.map('map-picker').setView(defaultCoords, 13);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            // Click Handler
            map.on('click', function (e) {
                const { lat, lng } = e.latlng;

                // Update Inputs
                document.getElementById('coords_lat').value = lat;
                document.getElementById('coords_lng').value = lng;

                // Update Marker
                // Update Marker
                if (marker) {
                    marker.setLatLng(e.latlng);
                } else {
                    marker = L.marker(e.latlng).addTo(map);
                }
            });

            // Fix Map Size on Load
            setTimeout(() => { map.invalidateSize(); }, 500);
        }

        function renderPartners() {
            const grid = document.getElementById('partner-grid');
            if (!grid || typeof PARTNERS_DATA === 'undefined') return;

            grid.innerHTML = PARTNERS_DATA.map(p => `
                <div onclick="selectPartner('${p.id}', '${p.name}', ${p.coords[0]}, ${p.coords[1]})" 
                     id="partner-${p.id}"
                     class="partner-card p-3 rounded-xl bg-white/5 border border-white/10 hover:bg-white/20 cursor-pointer transition-all flex flex-col items-center text-center gap-2 group">
                    <div class="w-10 h-10 rounded-full bg-black/50 flex items-center justify-center overflow-hidden border border-white/10 group-hover:border-electric">
                        <img src="${p.image}" class="w-full h-full object-contain">
                    </div>
                    <div>
                        <span class="text-xs font-bold text-white block group-hover:text-electric">${p.name}</span>
                    </div>
                </div>
            `).join('');
        }

        window.selectPartner = function (id, name, lat, lng) {
            // UI Selection
            document.querySelectorAll('.partner-card').forEach(el =>
                el.classList.remove('border-electric', 'bg-electric/10'));

            const selected = document.getElementById(`partner-${id}`);
            if (selected) selected.classList.add('border-electric', 'bg-electric/10');

            // Set Data
            document.getElementById('location-input').value = name;
            document.getElementById('partner-id-input').value = id;
            updateMap(lat, lng);
        };

        window.searchAddress = async function () {
            const query = document.getElementById('address-search').value;
            if (!query) return;

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    updateMap(lat, lon);
                    // Also auto-fill location name if empty
                    const locInput = document.getElementById('location-input');
                    if (!locInput.value) locInput.value = query; // Use search query as generic name
                } else {
                    alert('Location not found. Try a broader search.');
                }
            } catch (e) {
                console.error("Geocoding error:", e);
                alert('Error searching address.');
            }
        };

        function updateMap(lat, lng) {
            document.getElementById('coords_lat').value = lat;
            document.getElementById('coords_lng').value = lng;

            if (map) {
                map.setView([lat, lng], 15);
                if (marker) marker.setLatLng([lat, lng]);
                else marker = L.marker([lat, lng]).addTo(map);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Init Map
            initMap();
            renderPartners();

            // ... Rest of Init ...
            const G = window.Gamification;
            const E = window.Events;
            const N = window.Notifications;

            // ACL Check (Standardize on Level 5)
            // For demo purposes, we might want to bypass or make it easy
            const userLevel = G ? G.getLevel() : 0;
            const REQUIRED_LEVEL = 5;

            // NOTE: For testing, if level is too low, we show access denied.
            // If you want to test this, set your level to 5 in console: Gamification.addXP(1500, 'Admin Boost')

            if (userLevel < REQUIRED_LEVEL) {
                // document.getElementById('event-form-container').classList.add('hidden');
                // document.getElementById('access-denied').classList.remove('hidden');

                // FOR DEMO: Allow access but warn
                console.warn("User level too low, but allowing for demo.");
            }

            const form = document.getElementById('create-event-form');
            if (form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();

                    const formData = new FormData(form);

                    // Resources
                    const resources = [];
                    if (formData.get('resource_music')) resources.push('Music');
                    if (formData.get('resource_visuals')) resources.push('Visuals');
                    if (formData.get('resource_food')) resources.push('Food');

                    const eventData = {
                        title: formData.get('title'),
                        date: formData.get('date'),
                        location: formData.get('location'),
                        partnerId: formData.get('partnerId'),
                        coords: [formData.get('coords_lat'), formData.get('coords_lng')],
                        description: formData.get('description'),
                        image: formData.get('image'),
                        externalUrl: formData.get('externalUrl'), // Mandatory

                        // Hardcoded Link-Only values
                        price: 0,
                        quantity: 0,
                        ticketType: 'external',
                        isFree: false,

                        organizerLevel: userLevel,
                        resources: resources
                    };

                    // Save Event
                    E.createEvent(eventData);

                    // Notification Logic
                    if (N && resources.length > 0) {
                        N.send('action_required', `New Resource Request for "${eventData.title}": ${resources.join(', ')}`, 'admin');
                    }
                    if (N) {
                        N.send('info', `Event Created: ${eventData.title}`, 'all');
                    }

                    // Award XP (Standard for Link-Only)
                    if (G) {
                        G.addXP(300, 'Event Created (Link-Only)');
                    }

                    alert('Event Published Successfully!');
                    window.location.href = 'events.html';
                });
            }
        });
    </script>
</body>

</html>