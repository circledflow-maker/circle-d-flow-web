const mangaVolumes = {
    services: {
        title: "D Gallery",
        quote: "Hip Hop is the vibration of the street, Photography is the vibration of the soul.",
        story: `
            <p><strong>D Gallery</strong> represents my philosophy of photography, deeply rooted in the culture of Hip Hop.</p>
            <p>Just as Hip Hop is built on MCing, DJing, Breakdancing, Graffiti, and Knowledge, my photography is built on Voice, Vibe, Movement, Vision, and Understanding.</p>
            <div class="mt-4">
                <h4 class="text-amber font-bold mb-2">I kiss their heart:</h4>
                <ul class="text-xs space-y-1 text-mist">
                    <li><a href="https://www.instagram.com/mayafayaaaa/" target="_blank" class="hover:text-white">@mayafayaaaa</a></li>
                    <li><a href="https://www.instagram.com/alurontour/" target="_blank" class="hover:text-white">@alurontour</a></li>
                    <li><a href="https://www.instagram.com/no.qia/" target="_blank" class="hover:text-white">@no.qia</a></li>
                    <li><a href="https://www.instagram.com/breemakesart/" target="_blank" class="hover:text-white">@breemakesart</a></li>
                    <li><a href="https://www.instagram.com/outbreaktunes/" target="_blank" class="hover:text-white">@outbreaktunes</a></li>
                    <li><a href="https://www.instagram.com/cakeonboobs/" target="_blank" class="hover:text-white">@cakeonboobs</a></li>
                    <li><a href="https://www.instagram.com/secretgarden_lx/" target="_blank" class="hover:text-white">@secretgarden_lx</a></li>
                    <li><a href="https://www.instagram.com/mobbbeat/" target="_blank" class="hover:text-white">@mobbbeat</a></li>
                    <li><a href="https://www.instagram.com/yesyoucanspray" target="_blank" class="hover:text-white">@yesyoucanspray</a></li>
                    <li><a href="https://www.instagram.com/black.es_/" target="_blank" class="hover:text-white">@black.es_</a></li>
                    <li><a href="https://www.instagram.com/decifra_bts/" target="_blank" class="hover:text-white">@decifra_bts</a></li>
                    <li><a href="https://www.instagram.com/o.l.d.s/" target="_blank" class="hover:text-white">@o.l.d.s</a></li>
                    <li><a href="https://www.instagram.com/hempyrootslisboa/" target="_blank" class="hover:text-white">@hempyrootslisboa</a></li>
                    <li><a href="https://www.instagram.com/newdart/" target="_blank" class="hover:text-white">@newdart</a></li>
                    <li><a href="https://www.instagram.com/kreativlon.art/" target="_blank" class="hover:text-white">@kreativlon.art</a></li>
                </ul>
            </div>
        `,
        content: [
            // Chapter 1
            { type: "video", src: "Assets/images/Nikon Transfer 2/004/DSC_0777.MOV" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/004/DSC_0758.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/15novhempy015/DSC_8365.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1173.JPG" },
            { type: "image", src: "Assets/images/d_gallery_new.png" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt005/DSC_1319.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/003/DSC_0712.JPG" },

            // Chapter 2
            { type: "video", src: "Assets/images/Nikon Transfer 2/manuel23okt007/DSC_2445.MOV" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/manuel23okt007/DSC_3689.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/manuel23okt007/DSC_3712.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/cakes on boobs- dnl studio013/DSC_8118.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/cakes on boobs- dnl studio013/DSC_8022.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/cakesonboobs.village underground011/DSC_4760.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/cakes on boobs- dnl studio part 2014/DSC_5959.JPG" },

            // Chapter 3
            { type: "video", src: "Assets/images/Nikon Transfer 2/cakesonboobs.village underground011/DSC_4785.MOV" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/new chapter1010/DSC_4613.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/cakesonboobs.village underground011/DSC_5300.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/lisbon is calling-DBoys-Nabia-Willl%27Piovi012/DSC_5442.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/manuel23okt007/DSC_2321.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt005/DSC_1374.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/003/DSC_0710.JPG" },

            // Chapter 4
            { type: "video", src: "Assets/images/Nikon Transfer 2/yesyoucanspray/DSC_3799.MOV" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/yesyoucanspray/DSC_3803.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/yesyoucanspray/DSC_3796.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/yesyoucanspray/DSC_3818.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/yesyoucanspray/DSC_3776.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/yesyoucanspray/DSC_3789.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/yesyoucanspray/DSC_3750.JPG" },

            // Chapter 5
            { type: "video", src: "Assets/images/Nikon Transfer 2/003/DSC_0687.MOV" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/003/DSC_0583.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/003/DSC_0699.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/lisbon is calling-DBoys-Nabia-Willl%27Piovi012/DSC_0014.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/lisbon is calling-DBoys-Nabia-Willl%27Piovi012/DSC_5529.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/lisbon is calling-DBoys-Nabia-Willl%27Piovi012/DSC_5596.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/yesyoucanspray/DSC_3839.JPG" },

            // Last Page (Special Circle Layout)
            { 
                type: "circle-end", 
                images: [
                    "Assets/images/Nikon Transfer 2/cakesonboobs.village underground011/DSC_5269.JPG",
                    "Assets/images/Nikon Transfer 2/cakesonboobs.village underground011/DSC_5312.JPG",
                    "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1067.JPG",
                    "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1107.JPG",
                    "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1131.JPG"
                ]
            }
        ]
    },
    "portrait": {
        title: "Portrait Flow",
        quote: "The face is the mirror of the mind, and eyes without speaking confess the secrets of the heart.",
        story: `
            <p><strong>Portrait Flow</strong> is an exploration of the silent language spoken between the subject and the lens. It is not merely about capturing a likeness, but about unveiling the <em>essence</em>.</p>
            <p>In the stillness of a session, we strip away the masks worn for the world. What remains is raw, vulnerable, and undeniably beautiful.</p>
            <p>Every face tells a story—of joy, of struggle, of hope. This volume is a collection of those whispered stories, frozen in time but forever speaking.</p>
            <p>Look closely. In their eyes, you might just find a reflection of yourself.</p>
        `,
        content: [
            { type: "image", src: "Assets/images/Portrait/1-DSC_0759.jpg" },
            { type: "image", src: "Assets/images/Portrait/2-DSC_1097.jpg" },
            { type: "image", src: "Assets/images/Portrait/3-DSC_1176.jpg" },
            { type: "image", src: "Assets/images/Portrait/4-DSC_1244.jpg" },
            { type: "image", src: "Assets/images/Portrait/5-DSC_1292.jpg" },
            { type: "image", src: "Assets/images/Portrait/6-DSC_1378.jpg" },
            { type: "image", src: "Assets/images/Portrait/7-DSC_2001.jpg" },
            { type: "image", src: "Assets/images/Portrait/8-DSC_2038.jpg" },
            { type: "image", src: "Assets/images/Portrait/9-DSC_2231.jpg" },
            { type: "image", src: "Assets/images/Portrait/10-DSC_2327.jpg" },
            { type: "image", src: "Assets/images/Portrait/11-DSC_2399.jpg" },
            { type: "image", src: "Assets/images/Portrait/12-DSC_2908.jpg" },
            { type: "image", src: "Assets/images/Portrait/13-DSC_3374.jpg" },
            { type: "image", src: "Assets/images/Portrait/14-DSC_3552.jpg" },
            { type: "image", src: "Assets/images/Portrait/15-DSC_3566.jpg" },
            { type: "image", src: "Assets/images/Portrait/16-DSC_3787_1.jpg" },
            { type: "image", src: "Assets/images/Portrait/17-DSC_4613.jpg" },
            { type: "image", src: "Assets/images/Portrait/18-DSC_4760.jpg" },
            { type: "image", src: "Assets/images/Portrait/20-DSC_4815.jpg" },
            { type: "image", src: "Assets/images/Portrait/21-DSC_4846.jpg" },
            { type: "image", src: "Assets/images/Portrait/22-DSC_5077.jpg" },
            { type: "image", src: "Assets/images/Portrait/23-DSC_5184.jpg" },
            { type: "image", src: "Assets/images/Portrait/24-DSC_5214.jpg" },
            { type: "image", src: "Assets/images/Portrait/25-DSC_5219.jpg" }
        ]
    },
    "events": {
        title: "Event Energy",
        quote: "Energy flows where attention goes. Capture the vibration of the moment.",
        story: `
            <p>The <strong>Will of D.</strong> is not just a name—it is a storm. A ripple in the fabric of fate that inevitably causes a tidal wave of change.</p>
            <p>In the world of <strong>Hip Hop</strong>, this will manifests as the raw, unfiltered expression of the soul. It is the community gathering in the cipher, the breaker defying gravity, the MC speaking truth to power.</p>
            <p>We do not just observe the culture; we live it. Every beat, every movement, every shutter click is a testament to the values we hold: <em>Authenticity, Resilience, and Flow.</em></p>
            <p>This volume captures that energy. The mystic dark of the underground, illuminated by the violet haze of creativity. Here, we are not individuals. We are a collective force.</p>
        `,
        content: [
            // Rich Mix of HempyRoots14.okt004, HempyRoots14.okt005, and 004
            { type: "video", src: "Assets/images/Nikon Transfer 2/004/DSC_0777.MOV" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1002.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt005/DSC_1236.JPG" },
            
            { type: "video", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1001.MOV" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1024.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt005/DSC_1241.JPG" },
            
            { type: "video", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1298.MOV" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1054.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt005/DSC_1244.JPG" },
            
            { type: "video", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1323.MOV" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1083.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt005/DSC_1237.JPG" },
            
            { type: "video", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1052.MOV" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1115.JPG" },
            
            { type: "video", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1390.MOV" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1144.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt005/DSC_1238.JPG" },
            
            { type: "video", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1053.MOV" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1156.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt005/DSC_1242.JPG" },
            
            { type: "video", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1406.MOV" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1176.JPG" },
            
            { type: "video", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1154.MOV" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1207.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt005/DSC_1239.JPG" },
            
            { type: "video", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1407.MOV" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1236.JPG" },
            
            { type: "video", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1155.MOV" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1247.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt005/DSC_1265.JPG" },
            
            { type: "video", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1408.MOV" }
        ]
    },
    "community": {
        title: "Community",
        quote: "Nature does not hurry, yet everything is accomplished. Together we grow.",
        story: `
            <p><strong>Community</strong> is the heartbeat of our existence. In the <strong>Circle D Flow</strong>, we find that we are not islands, but waves in the same ocean.</p>
            <p>This volume celebrates the bonds that tie us together—the shared laughter, the collective movement, the unspoken understanding that we are stronger together.</p>
            <p>From the roots to the canopy, every member plays a vital role. We grow, we learn, and we ascend as one.</p>
            <p>Welcome to the tribe. Here, you are never alone.</p>
        `,
        content: [
            // 15novhempy015
            { type: "video", src: "Assets/images/Nikon Transfer 2/15novhempy015/DSC_8326.MOV" },
            { type: "video", src: "Assets/images/Nikon Transfer 2/15novhempy015/DSC_8327.MOV" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/15novhempy015/DSC_8333.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/15novhempy015/DSC_8334.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/15novhempy015/DSC_8335.JPG" },
            { type: "video", src: "Assets/images/Nikon Transfer 2/15novhempy015/DSC_8328.MOV" },
            // HempyRoots14.okt004 (reused as requested/implied mix)
            { type: "video", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1154.MOV" },
            { type: "video", src: "Assets/images/Nikon Transfer 2/HempyRoots14.okt004/DSC_1155.MOV" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/15novhempy015/DSC_8343.JPG" },
            { type: "image", src: "Assets/images/Nikon Transfer 2/15novhempy015/DSC_8345.JPG" }
        ]
    }
};

let currentVolume = null;
let currentPage = 0;
let totalPages = 0;

document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('manga-book-modal');
    const closeBtn = document.getElementById('close-book-btn');
    const nextBtn = document.getElementById('next-page-btn');
    const prevBtn = document.getElementById('prev-page-btn');
    const bookContainer = document.querySelector('.manga-book-container');
    const storySidebar = document.getElementById('manga-story-sidebar');
    const storyContent = document.querySelector('.story-text');
    
    // Lightbox Elements
    const lightboxModal = document.getElementById('lightbox-modal');
    const closeLightboxBtn = document.getElementById('close-lightbox-btn');
    const lightboxContent = document.querySelector('.lightbox-content');

    // Open Book
    document.querySelectorAll('.volume-cover').forEach(cover => {
        const openBookHandler = (e) => {
            // Prevent ghost clicks on touch devices if both events fire
            if (e.type === 'touchstart') e.preventDefault(); 
            const category = cover.dataset.category;
            openMangaBook(category);
        };

        cover.addEventListener('click', openBookHandler);
        cover.addEventListener('touchstart', openBookHandler, { passive: false });
    });

    // Close Book
    closeBtn.addEventListener('click', closeMangaBook);

    // Navigation
    nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages - 1) {
            currentPage++;
            updateBookView();
        }
    });

    prevBtn.addEventListener('click', () => {
        if (currentPage > 0) {
            currentPage--;
            updateBookView();
        }
    });

    // Keyboard Navigation
    document.addEventListener('keydown', (e) => {
        if (!modal.classList.contains('hidden') && lightboxModal.classList.contains('hidden')) {
            if (e.key === 'ArrowRight') nextBtn.click();
            if (e.key === 'ArrowLeft') prevBtn.click();
            if (e.key === 'Escape') closeMangaBook();
        }
        
        if (!lightboxModal.classList.contains('hidden')) {
            if (e.key === 'Escape') closeLightbox();
        }
    });

    // Lightbox Close
    closeLightboxBtn.addEventListener('click', closeLightbox);
    lightboxModal.addEventListener('click', (e) => {
        if (e.target === lightboxModal) closeLightbox();
    });

    // Event Delegation for "Book a Session" button in Manga Book
    bookContainer.addEventListener('click', (e) => {
        if (e.target.id === 'manga-book-session-btn' || e.target.closest('#manga-book-session-btn')) {
            e.preventDefault();
            e.stopPropagation(); // Prevent page flip
            
            if (typeof openOfferModal === 'function') {
                openOfferModal();
            } else if (window.openOfferModal) {
                window.openOfferModal();
            } else {
                console.error("openOfferModal not found");
                window.open("https://calendar.app.google/XbmJUDtaSWecgEXHA", "_blank");
            }
        }
    });

    function openMangaBook(category) {
        currentVolume = mangaVolumes[category];
        if (!currentVolume) return;

        // Setup Story Sidebar
        if (currentVolume.story) {
            storyContent.innerHTML = currentVolume.story;
            storySidebar.classList.remove('hidden');
            setTimeout(() => storySidebar.classList.add('visible'), 100);
        } else {
            storySidebar.classList.remove('visible');
            storySidebar.classList.add('hidden');
        }

        generatePages(currentVolume.content);
        currentPage = 0;
        updateBookView();
        
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.add('active');
        }, 10); // Small delay for transition
    }

    function closeMangaBook() {
        modal.classList.remove('active');
        setTimeout(() => {
            modal.classList.add('hidden');
            // Clear pages to save memory/reset
            const container = document.querySelector('.manga-book-container');
            container.innerHTML = ''; 
            storySidebar.classList.remove('visible');
            storySidebar.classList.add('hidden');
        }, 500);
    }

    function generatePages(contentList) {
        const container = document.querySelector('.manga-book-container');
        container.innerHTML = ''; // Clear existing

        // We'll put 3 items per page to create a manga layout (1 Hero + 2 Small)
        const itemsPerPage = 3;
        const numContentPages = Math.ceil(contentList.length / itemsPerPage);
        
        // +1 for the "Last Page" (Logo/Quote)
        totalPages = numContentPages + 1;

        for (let i = 0; i < numContentPages; i++) {
            const pageDiv = document.createElement('div');
            pageDiv.classList.add('manga-page');
            pageDiv.style.zIndex = totalPages - i; // Stack order

            // Create Grid
            const gridDiv = document.createElement('div');
            gridDiv.classList.add('manga-panel-grid');
            
            // Add items to this page
            const start = i * itemsPerPage;
            const end = Math.min(start + itemsPerPage, contentList.length);
            const pageItems = contentList.slice(start, end);

            pageItems.forEach((item, index) => {
                const panel = document.createElement('div');
                panel.classList.add('manga-panel');
                // Simple logic to vary panel sizes based on index (simulating manga layout)
                // First item on page is often larger
                if (index === 0) panel.classList.add('hero-panel'); 
                
                // FIX: Full page for circle-end
                if (item.type === 'circle-end') {
                    panel.style.gridColumn = "1 / -1";
                    panel.style.gridRow = "1 / -1";
                    panel.style.zIndex = "10";
                    panel.style.border = "none";
                    panel.style.background = "transparent";
                }
                
                let mediaElement;
                if (item.type === 'video') {
                    mediaElement = document.createElement('video');
                    mediaElement.src = item.src;
                    // PERFORMANCE FIX: Don't autoplay immediately, handled by updateVideoPlayback
                    mediaElement.autoplay = false; 
                    mediaElement.muted = true;
                    mediaElement.loop = true;
                    mediaElement.playsInline = true;
                } else if (item.type === 'text') {
                    mediaElement = document.createElement('div');
                    mediaElement.classList.add('manga-text-panel', 'p-4', 'text-white', 'flex', 'flex-col', 'justify-center', 'h-full', 'bg-black/50');
                    mediaElement.innerHTML = item.text;
                } else if (item.type === 'circle-end') {
                    mediaElement = document.createElement('div');
                    mediaElement.className = 'circle-layout relative w-full h-full flex justify-center items-center bg-black/80 overflow-hidden';
                    
                    // Logo
                    const logo = document.createElement('img');
                    logo.src = 'Assets/images/logo.png';
                    logo.className = 'w-20 h-20 z-10 relative animate-pulse';
                    mediaElement.appendChild(logo);

                    // Images in Circle
                    const radius = 120; // px
                    const totalImages = item.images.length;
                    
                    item.images.forEach((imgSrc, i) => {
                        const angle = (i / totalImages) * 2 * Math.PI;
                        const x = Math.cos(angle) * radius;
                        const y = Math.sin(angle) * radius;
                        
                        const img = document.createElement('img');
                        img.src = imgSrc;
                        img.className = 'absolute w-16 h-16 rounded-full object-cover border-2 border-amber shadow-lg shadow-amber/20';
                        img.style.transform = `translate(${x}px, ${y}px)`;
                        
                        // Add simple animation
                        img.animate([
                            { transform: `translate(${x}px, ${y}px) scale(1)` },
                            { transform: `translate(${x}px, ${y}px) scale(1.1)` },
                            { transform: `translate(${x}px, ${y}px) scale(1)` }
                        ], {
                            duration: 3000,
                            delay: i * 500,
                            iterations: Infinity
                        });

                        mediaElement.appendChild(img);
                    });
                } else {
                    mediaElement = document.createElement('img');
                    mediaElement.src = item.src;
                    mediaElement.loading = "lazy";
                }
                
                // Add Click Event for Lightbox
                panel.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent page flip if any
                    openLightbox(item);
                });

                panel.appendChild(mediaElement);
                gridDiv.appendChild(panel);
            });

            pageDiv.appendChild(gridDiv);
            container.appendChild(pageDiv);
        }

        // Add Last Page (Logo + Quote)
        const lastPage = document.createElement('div');
        lastPage.classList.add('manga-page', 'last-page');
        lastPage.style.zIndex = 0;
        lastPage.innerHTML = `
            <div class="last-page-content">
                <img src="Assets/images/logo.png" alt="Logo" class="last-page-logo">
                <p class="taoist-quote">"${currentVolume.quote}"</p>
                <a href="javascript:void(0)" class="book-session-btn" id="manga-book-session-btn">Book a Session</a>
            </div>
        `;
        container.appendChild(lastPage);
    }

    function updateBookView() {
        const pages = document.querySelectorAll('.manga-page');
        pages.forEach((page, index) => {
            if (index < currentPage) {
                page.classList.add('flipped');
                page.style.zIndex = index; // Lower z-index for flipped pages
            } else {
                page.classList.remove('flipped');
                page.style.zIndex = totalPages - index; // Higher z-index for unflipped
            }
        });

        // Update Buttons
        prevBtn.disabled = currentPage === 0;
        nextBtn.disabled = currentPage === totalPages - 1;

        // PERFORMANCE FIX: Only play videos on visible pages
        updateVideoPlayback();
    }

    function updateVideoPlayback() {
        const pages = document.querySelectorAll('.manga-page');
        pages.forEach((page, index) => {
            const videos = page.querySelectorAll('video');
            // Play videos if it's the current page or the next one (for smoother transition)
            // But strictly, for performance, only current is best. Let's try current + next.
            if (index === currentPage) {
                videos.forEach(v => v.play().catch(() => {}));
            } else {
                videos.forEach(v => v.pause());
            }
        });
    }

    function openLightbox(item) {
        lightboxContent.innerHTML = ''; // Clear previous

        let mediaElement;
        if (item.type === 'video') {
            mediaElement = document.createElement('video');
            mediaElement.src = item.src;
            mediaElement.controls = true;
            mediaElement.autoplay = true;
            mediaElement.loop = true;
        } else {
            mediaElement = document.createElement('img');
            mediaElement.src = item.src;
        }

        lightboxContent.appendChild(mediaElement);
        lightboxModal.classList.remove('hidden');
        setTimeout(() => {
            lightboxModal.classList.add('active');
        }, 10);
    }

    function closeLightbox() {
        lightboxModal.classList.remove('active');
        setTimeout(() => {
            lightboxModal.classList.add('hidden');
            lightboxContent.innerHTML = ''; // Stop video playback
        }, 300);
    }
});
